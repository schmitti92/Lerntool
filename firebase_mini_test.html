<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lerntool â€“ Firebase Mini-Test (B)</title>
  <style>
    :root{--card:#111b33;--muted:#93a4c7;--txt:#e9f0ff;--ok:#2bd576;--bad:#ff5b6e;--warn:#ffd166;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#07101f);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 60px;}
    h1{font-size:20px;margin:6px 0 4px;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr;}}
    .card{background:rgba(17,27,51,.86);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.35);padding:14px;}
    .row{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:520px){.row{grid-template-columns:1fr 1fr;}}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--txt);padding:10px 12px;outline:none;}
    textarea{min-height:110px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;line-height:1.35;}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .primary{background:linear-gradient(135deg,#3aa0ff,#7b5cff);color:white;}
    .ghost{background:rgba(255,255,255,.06);color:var(--txt);border:1px solid rgba(255,255,255,.12);}
    .danger{background:rgba(255,91,110,.12);color:#ffd8dd;border:1px solid rgba(255,91,110,.35);}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);margin:8px 0 0;}
    .dot{width:9px;height:9px;border-radius:50%;}
    .dot.ok{background:var(--ok);} .dot.bad{background:var(--bad);} .dot.warn{background:var(--warn);}
    .mini{font-size:12px;color:var(--muted);}
    .k{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#cfe0ff;}
    .hint{font-size:12px;color:var(--muted);margin:10px 0 0;line-height:1.35}
    .list{margin:8px 0 0;padding:0;list-style:none}
    .list li{padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);margin-bottom:8px}
    .list b{color:#ffffff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ§ª Firebase Mini-Test (nur Testdatei)</h1>
    <p class="sub">Ziel: Anonymous Auth + Firestore Write/Read testen, ohne dein Lerntool anzufassen.</p>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <label>Klasse (classId)</label>
            <input id="classId" value="ET24A" />
            <div class="hint">Pfad: <span class="k">classes/{classId}</span></div>
          </div>
          <div>
            <label>Klausur (examId)</label>
            <input id="examId" value="psych1" />
            <div class="hint">Pfad: <span class="k">classes/{classId}/exams/{examId}</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Nickname (nur Anzeige)</label>
            <input id="nick" value="Chris" />
          </div>
          <div>
            <label>Typ</label>
            <select id="type">
              <option value="flashcard">flashcard</option>
              <option value="quiz">quiz</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Frage</label>
            <input id="q" value="Was ist Vigilanz?" />
          </div>
          <div>
            <label>Antwort</label>
            <input id="a" value="Wachheitsgrad / Bewusstseinslage." />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnSend">ðŸ“¤ Testkarte online speichern</button>
          <button class="ghost" id="btnLoad">ðŸ”„ Letzte Karten laden</button>
          <button class="danger" id="btnClear">ðŸ§¹ Log leeren</button>
        </div>

        <div class="hint">
          <b>Wenn Auth scheitert:</b> Firebase â†’ Authentication â†’ Einstellungen â†’ <i>Autorisierte Domains</i> â†’ <span class="k">schmitti92.github.io</span> hinzufÃ¼gen.
        </div>
      </div>

      <div class="card">
        <div class="pill"><span class="dot warn" id="dot"></span><span id="statusText">Warte auf Initialisierungâ€¦</span></div>
        <div class="hint">
          Auth-UID: <span class="k" id="uid">â€“</span><br/>
          Projekt: <span class="k">lerntool-2545f</span>
        </div>
        <hr style="border:0;border-top:1px solid rgba(255,255,255,.08);margin:12px 0;">
        <div class="mini">Letzte Karten (max. 5):</div>
        <ul class="list" id="cards"></ul>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="mini">Log</div>
      <textarea id="log" readonly></textarea>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7qMIVSxZPmVcI81tnXebi4siF1QcGw90",
      authDomain: "lerntool-2545f.firebaseapp.com",
      projectId: "lerntool-2545f",
      storageBucket: "lerntool-2545f.firebasestorage.app",
      messagingSenderId: "33600931844",
      appId: "1:33600931844:web:3d7ef5efe5a16355234d51"
    };

    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const dot = $("dot");
    const statusText = $("statusText");
    const uidEl = $("uid");
    const cardsEl = $("cards");

    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.value += `[${t}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(kind, text){
      dot.className = "dot " + kind;
      statusText.textContent = text;
    }
    function clearCards(){ cardsEl.innerHTML = ""; }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function addCardLine(docId, data){
      const li = document.createElement("li");
      li.innerHTML = `<b>${escapeHtml(data.type || "card")}</b> Â· <span class="k">${docId}</span><br/>
                      <span class="mini">${escapeHtml(data.question || "")}</span>`;
      cardsEl.appendChild(li);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    setStatus("warn","Initialisiere Authâ€¦");
    log("Init: Firebase gestartet.");

    try{
      await signInAnonymously(auth);
      log("Auth: signInAnonymously() aufgerufen.");
    }catch(e){
      log("Auth-Fehler: " + (e?.message || e));
      setStatus("bad","Auth fehlgeschlagen (Authorized Domains prÃ¼fen).");
    }

    onAuthStateChanged(auth, (user) => {
      if(user){
        uidEl.textContent = user.uid;
        setStatus("ok","Auth OK (anonym). Bereit.");
        log("Auth OK: uid=" + user.uid);
      }else{
        uidEl.textContent = "â€“";
        setStatus("bad","Nicht angemeldet.");
        log("Auth: user=null");
      }
    });

    function sharedCardsCol(){
      const classId = $("classId").value.trim();
      const examId  = $("examId").value.trim();
      return collection(db, "classes", classId, "exams", examId, "sharedCards");
    }

    async function sendTestCard(){
      const classId = $("classId").value.trim();
      const examId  = $("examId").value.trim();
      if(!classId || !examId){
        log("Bitte classId & examId ausfÃ¼llen.");
        return;
      }
      try{
        const payload = {
          type: $("type").value,
          question: $("q").value.trim(),
          answer: $("a").value.trim(),
          authorName: $("nick").value.trim() || "anon",
          createdAt: serverTimestamp(),
          likes: 0,
          dislikes: 0,
          isHidden: false
        };
        const ref = await addDoc(sharedCardsCol(), payload);
        log("Firestore WRITE OK: docId=" + ref.id);
        await loadLatest();
      }catch(e){
        log("Firestore WRITE FEHLER: " + (e?.message || e));
        setStatus("bad","Firestore Fehler (Rules/Path prÃ¼fen).");
      }
    }

    async function loadLatest(){
      try{
        clearCards();
        const qy = query(sharedCardsCol(), orderBy("createdAt","desc"), limit(5));
        const snap = await getDocs(qy);
        log("Firestore READ OK: " + snap.size + " docs");
        if(snap.size === 0){
          const li = document.createElement("li");
          li.textContent = "Noch keine Karten gefunden.";
          cardsEl.appendChild(li);
          return;
        }
        snap.forEach(d => addCardLine(d.id, d.data()));
      }catch(e){
        log("Firestore READ FEHLER: " + (e?.message || e));
        setStatus("bad","Read Fehler (Index/Rules/createdAt).");
      }
    }

    $("btnSend").addEventListener("click", sendTestCard);
    $("btnLoad").addEventListener("click", loadLatest);
    $("btnClear").addEventListener("click", () => { logEl.value=""; log("Log geleert."); });

    setTimeout(loadLatest, 600);
  </script>
</body>
</html>
